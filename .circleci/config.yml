version: 2.1

commands:
  setup-automation:
    steps:
      - run:
          name: Setup automation
          command: |
            sudo apt-get -qq update -y
            sudo apt-get -q install -y ca-certificates curl wget make git
            (mkdir -p deps; cd deps; git clone https://github.com/RedisLabsModules/readies.git)
            sudo FORCE=1 ./deps/readies/bin/getpy3

jobs:
  test:
    machine:
      enabled: true
      image: ubuntu-2004:202010-01
    steps:
      - checkout
      - setup-automation
      - run:
          name: Install prerequisites
          command: |
            sudo ./deps/readies/bin/getredis -v6
            sudo make setup

      - run:
          name: Test
          command: |
            make test VERBOSE=1

workflows:
  version: 2
  build_and_package:
    jobs:
      - test:
          filters:
            tags:
              only: /.*/
            branches:
              only: /.*/
